"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.isSerializedFieldTypeDefinition = exports.deserializeFieldTypeDefinition = exports.serializeFieldTypeDefinition = exports.fieldTypesEqual = void 0;
const checks_1 = require("../../checks");
const basefieldtypedefinition_1 = require("./basefieldtypedefinition");
const collectionenumfieldtype_1 = require("./collectionenumfieldtype");
const fieldtypearray_1 = require("./fieldtypearray");
const literalfieldtype_1 = require("./literalfieldtype");
const ndimensionalfieldtypearray_1 = require("./ndimensionalfieldtypearray");
function fieldTypesEqual(a, b, checkEnumCollectionId = true) {
    if (a === b) {
        return true;
    }
    if ((0, literalfieldtype_1.isLiteralFieldType)(a) && (0, literalfieldtype_1.isLiteralFieldType)(b)) {
        return a.getLiteral() === b.getLiteral();
    }
    if ((0, collectionenumfieldtype_1.isCollectionEnumFieldType)(a) && (0, collectionenumfieldtype_1.isCollectionEnumFieldType)(b)) {
        return checkEnumCollectionId ? a.collectionId === b.collectionId : true;
    }
    a = (0, checks_1.isArray)(a) ? a : [a];
    b = (0, checks_1.isArray)(b) ? b : [b];
    const setA = new Set(a);
    const setB = new Set(b);
    if (setA.size !== setB.size) {
        return false;
    }
    for (const bItem of setB) {
        if (setA.has(bItem)) {
            continue;
        }
        if ((0, literalfieldtype_1.isLiteralFieldType)(bItem)) {
            const found = a.some((aItem) => (0, literalfieldtype_1.isLiteralFieldType)(aItem) && fieldTypesEqual(aItem, bItem));
            if (!found) {
                return false;
            }
        }
        else if (bItem instanceof fieldtypearray_1.FieldTypeArray) {
            const found = a.some((aItem) => aItem instanceof fieldtypearray_1.FieldTypeArray && fieldTypesEqual(aItem.validTypesArray, bItem.validTypesArray));
            if (!found) {
                return false;
            }
        }
        else if ((0, ndimensionalfieldtypearray_1.isNDimensionalFieldTypeArray)(bItem)) {
            const aItem = a.find(ndimensionalfieldtypearray_1.isNDimensionalFieldTypeArray);
            if (!aItem || !fieldTypesEqual(aItem.validTypesArray, bItem.validTypesArray)) {
                return false;
            }
        }
        else {
            return false;
        }
    }
    return true;
}
exports.fieldTypesEqual = fieldTypesEqual;
function serializeFieldTypeDefinition(fieldType) {
    if ((0, checks_1.isArray)(fieldType)) {
        return fieldType.map(basefieldtypedefinition_1.serializeBaseFieldTypeDefinition);
    }
    else {
        return (0, basefieldtypedefinition_1.serializeBaseFieldTypeDefinition)(fieldType);
    }
}
exports.serializeFieldTypeDefinition = serializeFieldTypeDefinition;
const deserializeFieldTypeDefinition = (serializedFieldType) => {
    if ((0, checks_1.isArray)(serializedFieldType)) {
        return serializedFieldType.map(basefieldtypedefinition_1.deserializeBaseFieldTypeDefinition);
    }
    return (0, basefieldtypedefinition_1.deserializeBaseFieldTypeDefinition)(serializedFieldType);
};
exports.deserializeFieldTypeDefinition = deserializeFieldTypeDefinition;
function isSerializedFieldTypeDefinition(definition) {
    if ((0, checks_1.isArray)(definition)) {
        return definition.every(basefieldtypedefinition_1.isSerializedBaseFieldTypeDefinition);
    }
    return (0, basefieldtypedefinition_1.isSerializedBaseFieldTypeDefinition)(definition);
}
exports.isSerializedFieldTypeDefinition = isSerializedFieldTypeDefinition;
